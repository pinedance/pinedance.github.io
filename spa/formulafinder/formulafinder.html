<!doctype html>
<html ng-app="gofangApp">
	<head>
        <title>goFang</title>
		<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.2/css/bootstrap.min.css">
		<link rel="stylesheet" href="../publicAsset/ng-tags-input/ng-tags-input.min.css">
		<link rel="stylesheet" href="../publicAsset/css/sticky-footer.css">	
		<meta name="viewport" content="width=device-width, initial-scale=1.0">	
	</head>
	<body ng-controller="FormulaCtrl">
		<header>
		<div class="jumbotron">
			<div class="container">
                <div class="row">
                    <div class="col-sm-6 col-xs-8">
                        <h1>goFang</h1>
                        <p>Find Your Own Formulas !!!</p>
                        <p><a class="btn btn-primary btn-lg" href="#" role="button" ng-click="resetForms()">Reset</a></p>
                    </div>
                    <div class="col-sm-6 col-xs-4">
                        <img src="http://livedoor.blogimg.jp/bakusei/imgs/c/a/cacbdc7e.jpg" alt="" width="160px" class="pull-right img-responsive img-rounded">
                    </div>
                </div>
            </div>
		</div>
		</header>
		
		<div class="container-fluid">
		<div class="row">
			<div class="col-sm-6">
				<tags-input ng-model="inHerbs" placeholder="포함하는 본초" min-length=1 display-property="herb" on-tag-added="find()" on-tag-removed="find()">
					<auto-complete source="loadItems($query)" min-length=1 debounce-delay=50></auto-complete>
				</tags-input>
			</div>
			<div class="col-sm-6">
				<tags-input ng-model="outHerbs" placeholder="제외하는 본초" min-length=1 display-property="herb" on-tag-added="find()" on-tag-removed="find()">
					<auto-complete source="loadItems($query)" min-length=1 debounce-delay=50></auto-complete>
				</tags-input>
				<p>{{test()}}</p>
			</div>
		</div>
		<div class="row">
			<div class="col-sm-6" ng-show="detail">
				<div class="well">
					<p>처방명 : {{detail.txName}}</p>
					<p>방극 : {{detail.txFangi}}<p>
					<p>구성 : {{detail.txGoo}}<p>
					<button type="button" class="btn btn-default" ng-repeat="h in herbdetails" ng-click="showHerbDetail(h)" >{{h}}</button>
					<blockquote><p>{{yack}}</p></blockquote>
				</div>
			</div>
			<div class="col-sm-6">
				<div clsss="list-group">
					<a href="#" class="list-group-item" ng-repeat="formula in results" ng-click="showDetail(formula)">{{formula}} </a>
				</div>
	  		</div>
		</div>



        
		</div><!--container-fluid-->
        
		<footer class="footer">
			<div class="container">
				<p class="text-muted">Copyright &copy; {{copyrightYear()}} Junho. <span  class="text-center">Contact or Report issue : <a href='https://github.com/pinedance/pinedance.github.io/issues' target='_blank'><kbd>Here</kbd></a></span></p>
				<small class="text-muted">This work is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/">Creative Commons Attribution-NonCommercial-ShareAlike 4.0 International License</a>.</small>
			</div>
		</footer>
		
<!--   script............................................................................................-->
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
		<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.2/js/bootstrap.min.js"></script>
		
		<script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.3.11/angular.min.js"></script>
		
		<script src="https://cdn.firebase.com/js/client/2.0.4/firebase.js"></script>
		<script src="https://cdn.firebase.com/libs/angularfire/0.9.1/angularfire.min.js"></script>

		<script src="../publicAsset/javascript/exArray.js"></script>
		<script src="../publicAsset/ng-tags-input/ng-tags-input.min.js"></script>

<!--   script............................................................................................-->		
		
		<script>
		(function(){
			var app = angular.module('gofangApp', ['firebase', 'ngTagsInput']);
			app.controller('FormulaCtrl', ['$scope', '$http', '$q', '$firebase', 
				function($scope, $http, $q, $firebase) {
					
					////copyright
					$scope.copyrightYear = function(){
						var thisYear = new Date().getFullYear();
						var startYear = 2015;
						if (thisYear > startYear) { 
							return(startYear + '-' + thisYear);
						} else {
							return(thisYear);
						}
					}
					
					//// firebase
					var ref = new Firebase("https://gofangapp.firebaseio.com/");
					var sync = $firebase(ref);
					var data = sync.$asObject();
				
					$scope.loadItems = function(query) {
						var deferred = $q.defer();
						var filtered = Object.keys(data.herbs).filter(function(s) { return s.indexOf(query) > -1; });
						deferred.resolve( filtered.map(function(item){ return { "herb": item } }) );
						return deferred.promise;
					};  ///solution : http://stackoverflow.com/questions/23069562/autocomplete-using-ngtagsinput-cannot-read-property-then-of-undefined
					
					$scope.find = function(){
						var tmp_in = $scope.inHerbs.map(function(item) { return item.herb });
						var tmp_out = $scope.outHerbs.map(function(item) { return item.herb });
						
						if ((tmp_in.length + tmp_out.length)==0){
							$scope.results = [];
						} else {
							var handler = Object.keys(data.formulas);
						
							for(var i=0; i < tmp_in.length ; i++){ 
								if(data.herbs[tmp_in[i]]){
									handler = handler.intersection( data.herbs[tmp_in[i]].link );
								} else {
									continue;
								}
							};
							for(var j=0; j < tmp_out.length ; j++){
								if(data.herbs[tmp_out[j]]){
									handler = handler.diff( data.herbs[tmp_out[j]].link );
								} else {
									continue;
								}
							};
			
							$scope.results = handler;
						}
					}

					$scope.showDetail = function(formula){ 
						$scope.detail = data.formulas[formula];
						$scope.herbdetails = Object.keys(data.formulas[formula].ing);
						$scope.yack = "약징 내용";
					}
					
					$scope.showHerbDetail = function(h){
						$scope.yack = data.herbs[h].txYG;
					}
					
					$scope.resetForms = function(){
						$scope.inHerbs = [];
						$scope.outHerbs = [];
						$scope.results = [];
						$scope.detail = false;
					}
			}]);
		})();
		</script>
	</body>
</html>
